<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/main.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <button type="button" onclick="endSession()">End Session</button>
      This is a session
      <p>Session nr: <span id="sessionID"></span></p>
      <div class="button-holder">
        <button type="button" onclick="addItemAndUpdate('Nikotin')">
          Nikotin
        </button>
        <button type="button" onclick="addItemAndUpdate('Annat')">Annat</button>
      </div>
      <p id="button-response"></p>
      <h2>Plockade saker:</h2>
      <p id="data-nikotin">Nikotin:</p>
      <p id="data-annat">Annat:</p>
      <button type="button" onclick="getSessionItemCount(sessionStorage.sessionID)">
        Update view
      </button>
      <a href="" id="download-link">
        <button type="button">
          Download Data
        </button></a
      >

      <h2>Karta</h2>
      <button type="button" onclick="getCoordsAndDrawMap()">Draw Map</button>
      <div id="map"></div>
    </div>
    </div>

    <script src="{{ url_for('static', filename='js/all.js') }}"></script>
    <script>
      // create a new session.
      let sessionID;

      function endSession() {
        // Clear sessionID
        sessionID = 0;
        sessionStorage.removeItem("sessionID");
        // return to start page
        window.location.href = "/";
      }

      async function addItemAndUpdate(type) {
        await sendItemPosition(type);
      }

      function setSessionID(sID) {
        document.querySelector("#sessionID").innerHTML = sID;
        document.querySelector("#download-link").href = `/download/${sID}`;
        sessionID = sID;
        sessionStorage.sessionID = sID;
      }

      function startSession() {
        if (sessionStorage.sessionID) {
          console.log("Found session ID: ", sessionStorage.sessionID);
          sID = sessionStorage.sessionID;
          setSessionID(sID);
          getData(sID);
        } else {
          let xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
              var sID = JSON.parse(xhttp.response);
              setSessionID(sID);
              sendItemPosition("Start");
            }
          };
          xhttp.open("GET", "/start_session", true);
          xhttp.send();
        }
      }

      // function downloadSessionData() {
      //   let xhttp = new XMLHttpRequest();
      //   xhttp.onreadystatechange = function() {
      //     if (this.readyState == 4 && this.status == 200) {
      //       var sessionItems = JSON.parse(xhttp.response);
      //       return sessionItems;
      //       console.log(sessionItems);
      //       download("session_data.csv", sessionItems);
      //     }
      //   };
      //   xhttp.open("GET", `/download/${sessionStorage.sessionID}`, true);
      //   xhttp.send();
      // }

      function getCoordsAndDrawMap() {
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var items = JSON.parse(xhttp.response);
            drawMap(items);
          }
        };
        xhttp.open(
          "GET",
          `/get_session_items/${sessionStorage.sessionID}`,
          true
        );
        xhttp.send();
      }

      function drawMap(items) {
        let start = items[0]
        console.log(start)
        let startLat = Number(start[1])
        let startLng = Number(start[2])

        var map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: { lat: startLat, lng: startLng }
        });

        // Center map
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              infoWindow.setPosition(pos);
              infoWindow.setContent("Location found.");
              infoWindow.open(map);
              map.setCenter(pos);
            },
            function() {
              handleLocationError(true, infoWindow, map.getCenter());
            }
          );
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }

        // Load targets
        for (item of items) {
          let itemType = item[0];
          let latLng = { lat: Number(item[1]), lng: Number(item[2]) };

          var marker = new google.maps.Marker({
            position: latLng,
            map: map,
            title: itemType
          });
          marker.setMap(map)
        }
      }

      var map, infoWindow;
      function initMap() {
        // map = new google.maps.Map(document.getElementById("map"), {
        //   center: { lat: -34.397, lng: 150.644 },
        //   zoom: 6
        // });
        // infoWindow = new google.maps.InfoWindow();

        // // Try HTML5 geolocation.
        // if (navigator.geolocation) {
        //   navigator.geolocation.getCurrentPosition(
        //     function(position) {
        //       var pos = {
        //         lat: position.coords.latitude,
        //         lng: position.coords.longitude
        //       };

        //       infoWindow.setPosition(pos);
        //       infoWindow.setContent("Location found.");
        //       infoWindow.open(map);
        //       map.setCenter(pos);
        //     },
        //     function() {
        //       handleLocationError(true, infoWindow, map.getCenter());
        //     }
        //   );
        // } else {
        //   // Browser doesn't support Geolocation
        //   handleLocationError(false, infoWindow, map.getCenter());
        // }
      }


      startSession();
    </script>
    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDGtFwEHjqnregA-SThEQLOuiHfw-_7Ot8&callback=initMap"
    ></script>
  </body>
</html>
